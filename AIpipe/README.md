# AIpipe

A pipeline for preparing imputed genotyping data and RNA-seq data for 
[GATK ASERead Counter](https://gatk.broadinstitute.org/hc/en-us/articles/360037428291-ASEReadCounter) and preparing data for 
differential analysis.
Before running this pipeline, refer to `Genopipe` to QC and impute raw
genotyping data.

## Workflow

1. Clone repo into working directory:

    ```bash
    git clone --no-checkout https://github.com/nekramer/CQTL.git AIpipe
    cd AIpipe
    git sparse-checkout init --cone
    git sparse-checkout set AIpipe
    git checkout
    ```
2. Edit the comma-separated `samplesheet.csv` with the names of `Read1` and `Read2` gzipped fastq files and the path to these files
under the `Sequencing_Directory` column. Additional sample metadata includes: `Proj`, `Donor`, `Condition`, `Time`, `Tech_Rep`, and `Seq_Rep`.

3. For the first workflow in the analysis (consisting of `snakefiles/VCFproc` and `snakefiles/RNAproc`), edit `config/config.yaml` for
parameters specific to your analysis. The parameters are described below:

    ```yaml
    ## Path to RNA-seq sample samplesheet
    samplesheet: 'samplesheet.csv'

    ## Path to imputed genotyping vcf
    vcf: '/path/to/imputed/genotyping.vcf.gz'

    ## Genome-specific reference parameters
    chromNames: 'chromNames.txt' # 2-column text file. 1st column: format of chromosome names in vcf file, 2nd column: required format of chromosome names for compatibility with sequencing contigs.
    genomeDir: '/proj/seq/data/STAR_genomes/GRCh38_p10_GENCODE' # Path to folder of STAR genome for alignment.
    chromSizes: '/proj/seq/data/STAR_genomes/GRCh38_p10_GENCODE/chrNameLength.txt' # Path to file of chromosome names and lengths.
    sequence: '/proj/phanstiel_lab/References/GENCODE.GRCh38.p10/Sequence/GRCh38.p10.genome.fa.gz' # Path to reference sequence gzipped fasta file. The associated sequence dictionary must be in the same directory as this file.
    ```

4. Submit the first workflow with `sbatch`:
    
    ```bash
    sbatch runAIpipe
    ```

After running these steps the pipeline will produce the following key files:
- `output/vcf/{vcf_prefix}_nodups_biallelic.vcf.gz` and `output/vcf/{vcf_prefix}_nodups_biallelic.vcf.gz`: VCF file and associated index for non-duplicated, biallelic variants with specified contigs.
- `output/{group}/alleleCounts/{group}_alleleCounts.csv`: Allele count tables generated by GATK ASEReadCounter for each variant, separated by donor.

5. Edit `contig/contig_AIanalysis.yaml` for the second part of the AI workflow with the following parameters:

    ```yaml
    ## Path to RNA-seq sample samplesheet 
    samplesheet: 'samplesheet.csv'

    ## AI analysis allele count, heterozygote, and weight value thresholds
    minTotalAlleleCounts: 10 # Minimum number of total read counts from both alleles of a variant to consider a donor as a heterozygote from RNA.
    minAlleleCounts: 2 # Minimum number of read counts from either allele of a variant to consider a donor as a heterozygote from RNA.
    minHets: 5 # Threshold of number of heterozygotes a variant must have to remain in the analysis.
    weightVal: 1e-6 # Weight value for variant homozygotes in weight matrix for differential analysis.
    ```
The path to the processed VCF file from the first workflow will be added to this config file.    
    
6. Submit the second workflow to combine and filter variant allele counts from donors and perform differential analysis of Allelic Imbalance:

    ```bash
    sbatch runAIanalysis
    ```
After running this workflow the pipeline will produce the following key files:

- `output/AI/differentialAllelicImbalance.rda`: An RData file containing the results of running `DESeq2` using the produced allele counts matrix and weight matrix.
- `output/AI/AI_variants.txt`: A text file listing the variant positions and their 
RSIDs for all the variants included in the analysis.

If you wish to re-run `DESeq2` manually, the necessary components can be found in `output/AI`:
- `alleleCountsMatrix_filtered_{minHets}.txt`: The allele counts matrix for each variant, separated by donor, treatment, and ref/alt alleles.
- `colData.txt`: Sample information for each of the columns in the allele counts matrix.
- `weightMatrix.txt`: The weight matrix for weighting heterozygotes and homozygotes.

## Reports

The following reports will be produced to help assess the filtering parameters 
associated with this workflow:

- `output/reports/snpStats.txt`: Count of number of variants for each separate sample before any kind of filtering. 

- `output/reports/unfiltered_commonSnps.txt`: Number of common variants all samples have pre-filtering.

- `output/reports/genohetStats.csv`: How many samples called heterozygous per variant based on 
genotyping data alone.

- `output/reports/total_RNAhets.csv`: How many samples called heterozygous per variant based on 
RNA-seq data alone.

- `output/reports/totalAlleleCountsReport_{minTotalAlleleCounts}_{minAlleleCounts}.csv`: Organized primarily by variant,
shows which samples satisfy the given minTotalAlleleCount and minAlleleCounts thresholds based on RNA-seq reads. 

- `output/reports/GenoRNA_errorStats.csv`: Organized by variant, number of donors called heterozygous based on genotype but have at least one allele with 0 RNA-seq counts AND 
number of donors called homozygous based on genotype but the alternate allele has
greater than or equal to 10 RNA-seq counts. This report shows potential genotyping errors.

- `output/AI/agreementReport.txt`: A text file generally showing the agreement between variants called heterozygotes and homozygotes from genotyping data versus RNA-seq data.